<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Stream Test</title>
    <style>
        body {
            background: #000;
            color: #0f0;
            font-family: monospace;
            padding: 20px;
        }
        img {
            max-width: 90%;
            border: 2px solid #0f0;
            margin: 20px 0;
        }
        .test {
            background: #111;
            padding: 10px;
            margin: 10px 0;
            border-left: 3px solid #0af;
        }
        .success { color: #0f0; }
        .error { color: #f00; }
        input {
            width: 400px;
            padding: 10px;
            background: #111;
            color: #0f0;
            border: 1px solid #333;
            font-family: monospace;
        }
        button {
            padding: 10px 20px;
            background: #0af;
            color: white;
            border: none;
            cursor: pointer;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>üîç Stream Diagnostics</h1>
    
    <div class="test">
        <h3>Test 1: Direct Stream Access</h3>
        <p>Enter your iPhone IP and port:</p>
        <input type="text" id="streamInput" placeholder="http://172.16.30.108:8889" value="http://172.16.30.108:8889">
        <button onclick="testStream()">Test Stream</button>
        <div id="streamResult"></div>
    </div>
    
    <div class="test">
        <h3>Test 2: MJPEG Stream</h3>
        <img id="streamImage" style="display:none;">
        <div id="imageStatus"></div>
    </div>
    
    <div class="test">
        <h3>Test 3: Single Frame</h3>
        <img id="frameImage" style="display:none;">
        <div id="frameStatus"></div>
    </div>
    
    <div class="test">
        <h3>Test 4: Server Reachability</h3>
        <div id="reachStatus"></div>
    </div>
    
    <script>
        console.log('üîç Diagnostic page loaded');
        
        function testStream() {
            const baseURL = document.getElementById('streamInput').value.trim();
            console.log('Testing:', baseURL);
            
            // Test 1: Try to fetch base URL
            document.getElementById('streamResult').innerHTML = '<p>Testing...</p>';
            
            fetch(baseURL)
                .then(r => {
                    document.getElementById('streamResult').innerHTML = 
                        `<p class="success">‚úÖ Base URL reachable (${r.status})</p>`;
                    testMJPEG(baseURL);
                    testFrame(baseURL);
                    testView(baseURL);
                })
                .catch(e => {
                    document.getElementById('streamResult').innerHTML = 
                        `<p class="error">‚ùå Cannot reach base URL: ${e.message}</p>`;
                });
        }
        
        function testMJPEG(baseURL) {
            const streamURL = `${baseURL}/stream.mjpeg?t=${Date.now()}`;
            console.log('Testing MJPEG:', streamURL);
            
            const img = document.getElementById('streamImage');
            img.src = streamURL;
            img.style.display = 'block';
            
            img.onload = function() {
                document.getElementById('imageStatus').innerHTML = 
                    `<p class="success">‚úÖ MJPEG stream working!</p>`;
                console.log('‚úÖ MJPEG loaded');
            };
            
            img.onerror = function() {
                document.getElementById('imageStatus').innerHTML = 
                    `<p class="error">‚ùå MJPEG stream failed</p>`;
                console.log('‚ùå MJPEG failed');
            };
        }
        
        function testFrame(baseURL) {
            const frameURL = `${baseURL}/frame.jpg?t=${Date.now()}`;
            console.log('Testing frame:', frameURL);
            
            const img = document.getElementById('frameImage');
            img.src = frameURL;
            img.style.display = 'block';
            
            img.onload = function() {
                document.getElementById('frameStatus').innerHTML = 
                    `<p class="success">‚úÖ Single frame works!</p>`;
                console.log('‚úÖ Frame loaded');
            };
            
            img.onerror = function() {
                document.getElementById('frameStatus').innerHTML = 
                    `<p class="error">‚ùå Frame failed</p>`;
                console.log('‚ùå Frame failed');
            };
        }
        
        function testView(baseURL) {
            const viewURL = `${baseURL}/view`;
            console.log('Testing view:', viewURL);
            
            fetch(viewURL)
                .then(r => r.text())
                .then(html => {
                    document.getElementById('reachStatus').innerHTML = 
                        `<p class="success">‚úÖ /view endpoint exists</p>`;
                })
                .catch(e => {
                    document.getElementById('reachStatus').innerHTML = 
                        `<p class="error">‚ùå /view not found: ${e.message}</p>`;
                });
        }
        
        // Auto-test with default
        setTimeout(() => {
            testStream();
        }, 1000);
    </script>
</body>
</html>